<div id="root"></div>

<script src="https://unpkg.com/@easychessanimations/foo@1.0.24/lib/fooweb.js"></script>	
<script src="https://unpkg.com/@easychessanimations/foo@1.0.24/lib/pieces.js"></script>	

<script src="out.js"></script>

<script>
	class Image_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "img"}})			
		}
		
		load(url, onload){
			this.e.onload = onload
			this.e.src = url
			return this
		}
		
		setWidth(width){
			this.e.width = width
			return this
		}
		
		setHeight(height){
			this.e.height = height
			return this
		}
	}
	function Image(props){return new Image_(props)}
	
	class select_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "select"}})			
		}
	}
	function select(props){return new select_(props)}
	
	class option_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "option"}})			
			this.value = props.value || "?"
			this.html(props.display || props.value || "?")
		}
	}
	function option(props){return new option_(props)}
	
	class Combo_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "div"}})			
			this.disp("inline-block")
			this.select = select()
			this.options = props.options || []
			this.selected = props.selected || null
			this.buildOptions()
			this.a(this.select)
			this.select.ae("change", this.selectChanged.bind(this))
		}
		
		buildOptions(){
			this.select.x()
			for(let opt of this.options){
				let opte = option(opt)				
				if(opt.value == this.selected) opte.e.setAttribute("selected", true)
				this.select.a(
					opte
				)
			}
		}
		
		selectChanged(){
			if(this.props.selectChangedCallback){
				this.props.selectChangedCallback(this.select.e.value)
			}
		}
		
		selectOption(value){
			this.selected = value
			this.buildOptions()
		}
	}
	function Combo(props){return new Combo_(props)}
	
	class ShowBoard_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "div"}})			
			
			props = props || {}
			
			this.uciInfo = {}
			
			this.squareSize = props.squareSize || 60
			this.pieceSize = props.pieceSize || Math.floor(this.squareSize * 0.8)
			this.pieceMargin = (this.squareSize - this.pieceSize) / 2
			this.numFiles = props.numFiles || 8
			this.numRanks = props.numRanks || 8
			this.boardWidth = this.numFiles * this.squareSize
			this.boardHeight = this.numRanks * this.squareSize
			this.legalMovesWidth = props.legalMovesWidth || 70
			this.controlPanelHeight = props.controlPanelHeight || 40
			
			this.variantKeys = props.variantKeys || ["standard"]
			this.variantKey = props.variantKey || "standard"
			
			this.pieceSet = props.pieceSet || "alpha"

			this.squareContainer = div().poa().w(this.boardWidth).h(this.boardHeight)
			
			this.clickContainer = div().poa().w(this.boardWidth).h(this.boardHeight)

			this.boardContainer = div().poa().w(this.boardWidth).h(this.boardHeight)
			
			this.legalMovesContainer = div().poa().l(this.boardWidth).w(this.legalMovesWidth).h(this.boardHeight).bc("#eee")
			
			this.controlButtons = props.controlButtons || ["<<", "<", ">", ">>", "X"]
			
			this.variantCombo = Combo({
				options: this.variantKeys.map(key => ({
					value: key,
					display: key
				})),
				selected: this.variantKey,
				selectChangedCallback: this.variantChanged.bind(this)
			})
			
			this.controlPanel = div()
				.fl().ai("center").jc("space-around")
				.poa().w(this.boardWidth).h(this.controlPanelHeight).t(this.boardHeight).bc("#eff")
				.a(
					button(this.reset.bind(this)).html("Reset"),
					this.variantCombo,
				   	this.controlButtons.map(cb => button(this.controlButtonPressed.bind(this, cb)).html(cb))
				)
			
			this.por().w(this.totalWidth()).h(this.totalHeight()).bc("#ddd")
				.a(this.squareContainer, this.boardContainer, this.clickContainer, this.legalMovesContainer, this.controlPanel)
			
			this.imgCache = {}
		}
		
		reset(){
			this.variantChanged(this.variantCombo.select.e.value)
		}
		
		variantChanged(variantKey){
			console.log("variant changed", variantKey)
			if(this.props.variantChangedCallback){
				this.props.variantChangedCallback(variantKey)
			}
		}
		
		totalWidth(){
			return this.boardWidth + this.legalMovesWidth
		}
		
		totalHeight(){
			return this.boardHeight + this.controlPanelHeight
		}
		
		controlButtonPressed(cb){
			if(this.props.controlButtonCallback){
				this.props.controlButtonCallback(cb)
			}
		}
		
		setFen(fen, legalMovesUcis, uciInfo){
			this.fen = fen
			this.legalMovesUcis = legalMovesUcis || []
			this.uciInfo = uciInfo || {}
			
			let raw = this.fen.split(" ")[0]
			raw = raw.replace(/\//g, "")
			for(let i=1;i<=8;i++) raw = raw.replace(new RegExp(`${i}`, "g"), "........".substring(0,i))
			
			this.raw = raw
			
			return this
		}
		
		indexToUci(i){
			let rank = Math.floor(i / this.numFiles)
			let file = i - rank * this.numFiles
			
			let rankUci = `${this.numRanks - rank}`
			let fileUci = String.fromCharCode(97 + file)
			
			return `${fileUci}${rankUci}`
		}
		
		clickMove(fromI, toI){
			let moveUci = `${this.indexToUci(fromI)}${this.indexToUci(toI)}`
			
			if(this.props.clickedMoveCallback){				
				this.props.clickedMoveCallback(moveUci)
			}
		}
		
		clickSquareClicked(i){
			if(this.clickedSquareIndex != null){
				this.clickedSquare.op(0)
				
				this.clickMove(this.clickedSquareIndex, i)
				
				this.clickedSquareIndex = null
				this.clickedSquare.op(0)
				
				return
			}
			
			this.clickedSquareIndex = i
			
			this.clickedSquare = this.clickSquares[i]
			
			this.clickedSquare.op(0.5)
		}
		
		draw(){
			this.squareContainer.x()
			this.boardContainer.x()
			
			this.clickSquares = {}
			
			this.clickedSquareIndex = null
			
			for(let file=0;file<this.numFiles;file++) for(let rank=0;rank<this.numRanks;rank++){
				let i = file + rank * 8
				
				this.squareContainer.a(div().poa().w(this.squareSize).h(this.squareSize).t(rank * this.squareSize).l(file * this.squareSize).bc((file+rank)%2?"#aaa":"#ddd"))
				
				this.clickContainer.a(this.clickSquares[i] = div().poa().w(this.squareSize).h(this.squareSize).t(rank * this.squareSize).l(file * this.squareSize).bc("#00f").op(0).ae("click", this.clickSquareClicked.bind(this, i)))
				
				let p = this.raw.substring(i, i+1)		
				
				if(p!="."){
					let cachedImg = this.imgCache[`${p}${i}`]
					
					if(cachedImg){
						this.boardContainer.a(cachedImg)
					}else{
						let img = Image().setWidth(this.pieceSize).setHeight(this.pieceSize).poa()						
						.l(file * this.squareSize + this.pieceMargin).t(rank * this.squareSize + this.pieceMargin)
						.load(PIECES_CSS[this.pieceSet][p.toLowerCase() == p ? "b" : "w"][p.toLowerCase()], _=>{
							this.boardContainer.a(img)
							this.imgCache[`${p}${i}`] = img
						})			
					}					
				}			
			}		
			
			this.legalMovesContainer.x()
				.addStyle("font-family", "monospace").ovfys().c("#007")
				.a(this.legalMovesUcis.sort().map(uci => div()
					.pad(3).mar(1).cursor("pointer")
					.bc(this.uciInfo[uci] ? this.uciInfo[uci].bc : "#ffe")
					.ae("click", _=>this.moveClicked(uci)).tac()
					.html(uci))
				 )
			
			return this
		}		
		
		moveClicked(uci){
			if(this.props.moveClickedCallback){
				this.props.moveClickedCallback(uci)
			}
		}
		
		setVariantKey(variantKey){
			this.variantKey = variantKey
			
			console.log(this.variantCombo)
			this.variantCombo.selectOption(this.variantKey)
		}
	}
	function ShowBoard(props){return new ShowBoard_(props)}
									  
	let sb = ShowBoard({
		moveClickedCallback: moveClickedCallback,
		controlButtonCallback: controlButtonCallback,
		variantKeys: ["standard", "atomic", "antichess", "horde", "racingKings", "kingOfTheHill", "threeCheck", "chess960", "fromPosition"],
		variantChangedCallback: variantChangedCallback,
		clickedMoveCallback: clickedMoveCallback
	}).bdrs("solid").bdrw(8).bdrc("#bbb").bdrr(10)
	
	let game = Game(undefined, undefined, "chessgame")
	
	game.load()
			
	setGame(game)
	
	function setGame(g){
		let uciInfo = {}
		let first = true
		for(let childId of g.currentNode.childIds){
			let node = g.getNodeById(childId)
			uciInfo[node.uci] = {
				bc: first ? "#0f0" : "#aaf"
			}
			first = false
		}
		sb.setFen(g.fen(),g.legalMovesUcis(), uciInfo).draw()
		sb.setVariantKey(g.variantKey)
		game.save()
	}
	
	function moveClickedCallback(uci){
		game.makeUciMove(uci)
		
		setGame(game)
	}
	
	function controlButtonCallback(cb){
		if(cb == "<") game.back()
		if(cb == ">") game.forward()
		if(cb == "<<") game.tobegin()
		if(cb == ">>") game.toend()
		if(cb == "X") game.del()
		
		setGame(game)
	}
	
	function variantChangedCallback(variantKey){
		game = Game(variantKey, undefined, "chessgame")
			
		setGame(game)
	}
	
	function clickedMoveCallback(moveUci){
		console.log("moveUci", moveUci)
		
		game.makeUciMove(moveUci)
		
		setGame(game)
	}

	let app = div().h(window.innerHeight - 20).bc("#ddf").fl().ai("center").jc("space-around").a(sb)
	
	document.getElementById("root").appendChild(app.e)
</script>
