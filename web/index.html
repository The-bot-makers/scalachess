<script src="https://unpkg.com/@easychessanimations/foo@1.0.22/lib/fooweb.js"></script>	

<script src="out.js"></script>
<script src="pieces.js"></script>

<script>
	class Image_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "img"}})			
		}
		
		load(url, onload){
			this.e.onload = onload
			this.e.src = url
			return this
		}
		
		setWidth(width){
			this.e.width = width
			return this
		}
		
		setHeight(height){
			this.e.height = height
			return this
		}
	}
	function Image(props){return new Image_(props)}
	
	class ShowBoard_ extends SmartdomElement_{
		constructor(props){
			super({...props, ...{tagName: "div"}})			
			
			props = props || {}
			
			this.pieceSize = props.pieceSize || 40
			this.squareSize = props.squareSize || 50
			this.pieceMargin = (this.squareSize - this.pieceSize) / 2
			this.numFiles = props.numFiles || 8
			this.numRanks = props.numRanks || 8
			this.boardWidth = this.numFiles * this.squareSize
			this.boardHeight = this.numRanks * this.squareSize
			this.legalMovesWidth = props.legalMovesWidth || 70
			
			this.pieceSet = props.pieceSet || "alpha"

			this.squareContainer = div().poa().w(this.boardWidth).h(this.boardHeight)

			this.boardContainer = div().poa().w(this.boardWidth).h(this.boardHeight)
			
			this.legalMovesContainer = div().poa().l(this.boardWidth).w(this.legalMovesWidth).h(this.boardHeight).bc("#eee")
			
			this.por().a(this.squareContainer, this.boardContainer, this.legalMovesContainer)
			
			this.imgCache = {}
		}
		
		setFen(fen, legalMovesUcis){
			this.fen = fen
			this.legalMovesUcis = legalMovesUcis || []
			
			let raw = this.fen.split(" ")[0]
			raw = raw.replace(/\//g, "")
			for(let i=1;i<=8;i++) raw = raw.replace(new RegExp(`${i}`, "g"), "........".substring(0,i))
			
			this.raw = raw
			
			return this
		}
		
		draw(){
			this.squareContainer.x()
			this.boardContainer.x()
			
			for(let file=0;file<this.numFiles;file++) for(let rank=0;rank<this.numRanks;rank++){
				this.squareContainer.a(div().poa().w(this.squareSize).h(this.squareSize).t(rank * this.squareSize).l(file * this.squareSize).bc((file+rank)%2?"#aaa":"#ddd"))

				let i = file + rank * 8
				let p = this.raw.substring(i, i+1)		
				
				if(p!="."){
					let cachedImg = this.imgCache[`p${i}`]
					
					if(cachedImg){
						this.boardContainer.a(cachedImg)
					}else{
						let img = Image().setWidth(this.pieceSize).setHeight(this.pieceSize).poa()						
						.l(file * this.squareSize + this.pieceMargin).t(rank * this.squareSize + this.pieceMargin)
						.load(PIECES_CSS[this.pieceSet][p.toLowerCase() == p ? "b" : "w"][p.toLowerCase()], _=>{
							this.boardContainer.a(img)
							this.imgCache[`p${i}`] = img
						})			
					}					
				}			
			}		
			
			this.legalMovesContainer.x()
				.addStyle("font-family", "monospace").ovfys().c("#007")
				.a(this.legalMovesUcis.sort().map(uci => div()
					.pad(3).mar(1).bc("#ffe").cursor("pointer")
					.ae("click", _=>this.moveClicked(uci)).tac()
					.html(uci))
				 )
			
			return this
		}		
		
		moveClicked(uci){
			if(this.props.moveClickedCallback){
				this.props.moveClickedCallback(uci)
			}
		}
	}
	function ShowBoard(props){return new ShowBoard_(props)}
	
	let game = Game('atomic')
	
	let sb = ShowBoard({
		moveClickedCallback: moveClickedCallback
	}).setFen(game.fen(), game.legalMovesUcis()).draw()
	
	function moveClickedCallback(uci){
		game.makeUciMove(uci)
		sb.setFen(game.fen(), game.legalMovesUcis()).draw()
	}

	let app = sb
	
	document.documentElement.appendChild(app.e)
</script>
